---
title: "CNN models evaluation"
author: "Carlos Ruiz"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Introduction

In this document, we compared the features generated by two CNN models in a whole blood dataset of two rare diseases (Kabuki and CHARGE). We trained two CNN models, one using the whole TCGA and the other with a reference dataset of whole blood samples. Our aim is to investigate whether the features generated by the CNN models are able to discriminate Kabuki and CHARGE samples from control samples (GSE97362 dataset).

```{r}
library(HDF5Array)
library(SummarizedExperiment)
library(tidyverse)
library(limma)
library(pheatmap)
library(e1071)
library(meffil)
```

# Initial dataset

## Descriptives

```{r}
se <- loadHDF5SummarizedExperiment("../data/GSE97362/", prefix = "GSE97362_raw")
se$disease <- factor(se$`disease state:ch1`, levels = c("Control", "CHARGE", "Kabuki",  "CHD7 variant","KMT2D variant"))
se$sex <- ifelse(se$characteristics_ch1 == "gender: female", "female", "male")
se$age <- as.numeric(gsub("age (years): ", "", se$characteristics_ch1.1, fixed = TRUE ))

discov <- se[, ! se$`sample type:ch1`  %in% c("Control for validation cohort",  "Validation cohort") ]
val <- se[, se$`sample type:ch1` %in% c("Control for validation cohort",  "Validation cohort") ]
```

Our initial dataset contained `r ncol(se)` individuals and `r nrow(se)` CpGs. Of the `r ncol(se)` samples, `r sum(se$disease == "Control")` were controls, `r sum(se$disease == "CHARGE")` had CHARGE while\
`r sum(se$disease == "Kabuki")` had Kabuki. The remaining individuals had variants candidate of causing one of the diseases. We also have `r sum(se$sex == "male")` boys and `r sum(se$sex == "female")` girls.

## Overall pattern

We first explored whether there were clusters of samples with distinctive global methylation patterns. To test this, we run a PCA on this data. We only included the 40K CpGs with highest variance:

```{r}
pc_ini <- meffil.methylation.pcs(data.matrix(assay(se)), probe.range = 40000) %>%
  data.frame()
pc_ini$disease <- colData(se)[rownames(pc_ini), "disease"]
pc_ini$sex <- colData(se)[rownames(pc_ini), "sex"]
pc_ini %>% 
  ggplot(aes(x = PC1, y = PC2, color = disease)) +
  geom_point() + 
  theme_bw() +
  ggtitle("All CpGs - Disease")

```

Some individuals have different methylation patterns in the PC2. These differences seem to be related with disease status. Therefore, we explored other principal components:

```{r}
pc_ini %>% 
  ggplot(aes(x = PC3, y = PC4, color = disease)) +
  geom_point() + 
  theme_bw() +
  ggtitle("All CpGs - Disease")

pc_ini %>% 
  ggplot(aes(x = PC2, y = PC4, color = disease)) +
  geom_point() + 
  theme_bw() +
  ggtitle("All CpGs - Disease")

```

We also observed some differences due to disease in PC4. When combining PC2 and PC4, we observed that PC2 differentiates CHARGE (and CHD7 variants, variants suspected of causing CHARGE) from control samples, while PC4 differentiates control samples from Kabuki (and KMT2D variants).

```{r}
pc_ini %>% 
  ggplot(aes(x = PC1, y = PC2, color = sex)) +
  geom_point() + 
  theme_bw() +
  ggtitle("All CpGs - Sex")
```

We do not observe difference between boys and girls in the first 2 PCs. Thus, the patterns of sex are weaker than the patterns of the disease.

## Application of state-of-the-art method

Before going to the CNN models, we will test how the current state-of-the-art method works in this dataset. Briefly, the current method has two steps:

1.  Define the CpGs with more different methylation values between cases and controls
2.  Use these CpGs to train a SVM model.

In the original paper, the authors had a set of samples with known disease status (labelled as CHARGE or Kabuki), and another set with suspicious variants (CHD7 or KMT2D variants). They trained the model in the samples with known status and applied it to the samples with suspicious variants. We will use the same data division.

Thus, we will use samples with known status to define the set of CpGs differentiating cases from controls and then train the SVM. We will select probes with an adjusted p-value \< 0.01 and a FC \> 0.1 (in absolute value).

### Feature selection

```{r}

diseases <- c("CHARGE", "Kabuki")
names(diseases) <- c("CHARGE", "Kabuki")

getFeatures <- function(set, disease, minFC = 0.1){
  
  set <- set[, set$disease %in% c("Control", disease)]
  set$disease <- droplevels(set$disease)
  model <- model.matrix(~ disease + sex + age, colData(set))
  
  lmF <- lmFit(assay(set[, rownames(model)]), model)
  lmFe <- eBayes(lmF)
  tabA <- topTable(lmFe, coef = 2, n = Inf)
  selTab <- subset(tabA, !is.na(logFC) & adj.P.Val < 0.01 & abs(logFC) > minFC)
  selCpGs <- rownames(selTab)
  
}
sel_cpgs <- lapply(diseases, getFeatures, set = discov)
sel_cpgs_vec <- unique(unlist(sel_cpgs))
```

A total of `r length(sel_cpgs$CHARGE)` and `r length(sel_cpgs$Kabuki)` CpGs had different methylation values in controls than in CHARGE or Kabuki, respectively.

```{r}
col_colors <- list(
  disease = c("Control" = "black", "CHARGE" = "green", "Kabuki" = "blue",
              "CHD7 variant" = "lightgreen", "KMT2D variant" = "cyan"),
  sex = c("female" = "purple", "male" = "lightblue")
)

pheatmap(assay(discov)[sel_cpgs_vec, ], scale = "none", 
         annotation_col  = data.frame(colData(discov)[, "disease", drop = FALSE]),
         annotation_colors =  col_colors, 
         show_rownames = FALSE)

```

The heatmap shows that when including only these selected CpGs, control and case samples are clearly separated in the discovery dataset (dataset used for defining the CpGs). Nonetheless, we observe that CHARGE individuals are separated in two groups, with some samples more similar to control samples.

```{r}
pheatmap(assay(val)[sel_cpgs_vec, ], scale = "none", 
         annotation_col  = data.frame(colData(val)[, "disease", drop = FALSE]),
         annotation_colors =  col_colors, 
         show_rownames = FALSE)
```

When selecting the same CpGs in the validation dataset, we observe that samples with variants are separeted from controls. In addition, samples with CHD7 variants are separated from samples with KMT2D variants.

### SVM training

```{r}
trainSVM <-  function(set, feats){
  mat <- data.matrix(assay(set[feats, ]))
  imp_mat <- meffil:::impute.matrix(mat, margin = 1, fun = function(x) median(x, na.rm = T))
  
  df <- data.frame(pathClass = factor(set$disease), t(imp_mat))
  model_svm <- svm(pathClass ~ ., df)
}
svm_cpgs <- trainSVM(set = discov, feats = sel_cpgs_vec)

all_mat <- data.matrix(t(assay(se[sel_cpgs_vec, ])))
imp_mat <- meffil:::impute.matrix(all_mat, margin = 2, fun = function(x) median(x, na.rm = T))

pred_cpgs <- predict(svm_cpgs, imp_mat)
table(pred_cpgs, se$disease)

```

The SVM model achieved a very high accuracy. Only one control samples was mislabelled and identified as CHARGE. From the individuals with candidate pathogenic variants, all but 3 were classified under their right disease. 3 individuals with CHD7 variant were classified as control, but we cannot state whether they are a classification error or whether these individuals do not have the pathogenic methylation pattern.

# TCGA model

## Description

We train a CNN model in TCGA whose goal was to classify samples into their tumor subtype, including all control tissues as one category. The input contained 9813 samples (80% training/20% test) and the 337,673 CpGs with variability in TCGA. Then, the model had the following layers:

| Layer (type)                  | Output Shape      | Param    |
|-------------------------------|-------------------|----------|
| conv1d_1 (Conv1D)             | (None, 42202, 12) | 780      |
| activation_1 (Activation)     | (None, 42202, 12) | 0        |
| max_pooling1d_1 (MaxPooling1) | (None, 5275, 12)  | 0        |
| flatten_1 (Flatten)           | (None, 63300)     | 0        |
| dense_1 (Dense)               | (None, 256)       | 16205056 |
| dense_2 (Dense)               | (None, 34)        | 8738     |

Hyperparameters (from random search):

-   CNN kernel size: 64
-   CNN stride: 8
-   Max pool size: 8
-   Activation: relu

## CNN output

### General pattern

We first evaluated whether the output of the CNN layers still contained signal to differentiate the individuals by disease.

```{r}
tcga_cnn <- read_delim("../results/gse97362_TCGA/2021-09-28/model_features/flatten_1.tsv", delim = "\t")
tcga_cnn <- data.matrix(tcga_cnn)

tcga_cnn_se <- SummarizedExperiment(t(tcga_cnn), colData = colData(se))
rownames(tcga_cnn_se) <- paste0("Features", seq_len(nrow(tcga_cnn_se)))

discov_tcga_cnn <- tcga_cnn_se[, ! tcga_cnn_se$`sample type:ch1`  %in% c("Control for validation cohort",  "Validation cohort") ]
valid_tcga_cnn <- tcga_cnn_se[, tcga_cnn_se$`sample type:ch1`  %in% c("Control for validation cohort",  "Validation cohort") ]
```

We obtained `r nrow(tcga_cnn_se)` features from the CNN layer. Of those, `r sum(!apply(tcga_cnn, 2, function(x) all(x == 0)))` had values different than 0 in at least a sample.

```{r}
pc_tcga_cnn <- prcomp(tcga_cnn)$x %>%
  data.frame()
rownames(pc_tcga_cnn) <- colnames(tcga_cnn_se)
pc_tcga_cnn$disease <- colData(se)[rownames(pc_tcga_cnn), "disease"]
pc_tcga_cnn$sex <- colData(se)[rownames(pc_tcga_cnn), "sex"]
```

```{r}
pc_tcga_cnn %>% 
  ggplot(aes(x = PC1, y = PC2, color = disease)) +
  geom_point() + 
  theme_bw() +
  ggtitle("TCGA CNN features - Disease")
```

The top 2 PCs of CNN features from TCGA model does not allow differentiating the cases from the the control individuals.

```{r}
pc_tcga_cnn %>% 
  ggplot(aes(x = PC4, y = PC9, color = disease)) +
  geom_point() + 
  theme_bw() +
  ggtitle("TCGA CNN features - Disease")
```

Components PC4 and PC9 of features from TCGA CNN cluster samples by disease type. Nonetheless, the clustering was better when using the full dataset.

```{r}
pc_tcga_cnn %>% 
  ggplot(aes(x = PC1, y = PC2, color = sex)) +
  geom_point() + 
  theme_bw() +
  ggtitle("TCGA CNN features - Sex")
```

The first component clearly cluster samples by sex.

Summary: the features computed by the TCGA CNN model are capturing the difference in methylation due to sex, while the differences due to the disease are not well captured.

### Features selection

```{r}
sel_tcga_cnn <- lapply(diseases, getFeatures, set = discov_tcga_cnn, minFC = 0.05)
sel_tcga_cnn_vec <- unique(unlist(sel_tcga_cnn))
```

A total of `r length(sel_tcga_cnn$CHARGE)` and `r length(sel_tcga_cnn$Kabuki)` features had different methylation values in controls than in CHARGE or Kabuki, respectively.

```{r}
pheatmap(assay(discov_tcga_cnn)[sel_tcga_cnn_vec, ], scale = "none", 
         annotation_col  = data.frame(colData(discov_tcga_cnn)[, c("disease", "sex"), drop = FALSE]),
         annotation_colors =  col_colors, 
         show_rownames = FALSE)

```

Kabuki and control samples are clearly separated. Nonetheless, the differences between CHARGE and control are not so strong than when using all the CpGs.

```{r}
pheatmap(assay(valid_tcga_cnn)[sel_tcga_cnn_vec, ], scale = "none", 
         annotation_col  = data.frame(colData(valid_tcga_cnn)[, c("disease", "sex"), drop = FALSE]),
         annotation_colors =  col_colors, 
         show_rownames = FALSE)
```

We observed clusters of individuals with suspicious variants but no clear differences between cases and controls are observed.

### SVM training

```{r}
svm_tcga_cnn <- trainSVM(set = discov_tcga_cnn, feats = sel_tcga_cnn_vec)

pred_tcga_cnn <- predict(svm_tcga_cnn, t(assay(tcga_cnn_se)))
table(pred_tcga_cnn, se$disease)

```

With this data, the SVM model presented a lower accuracy. Now, it missclassified 6 individuals from the training dataset, including 4 controls identified as cases. The classification of suspicious variants had more individuals classified as controls. Nonetheless, these results are more concordant with those published in the original paper.

Summary: The CNN network have reduced the differences between the different disease group but it is still sufficient to classify the individuals. Nonetheless, using the output of this layer for transfer learning is not enough to differentiate the subtypes.

## Dense network output

### General pattern

We first evaluated whether the output of the dense layer still contained signal to differentiate the individuals by disease.

```{r}
tcga_dense <- read_delim("../results/gse97362_TCGA/2021-09-28/model_features/dense_1.tsv", delim = "\t")
tcga_dense <- data.matrix(tcga_dense)

tcga_dense_se <- SummarizedExperiment(t(tcga_dense), colData = colData(se))
rownames(tcga_dense_se) <- paste0("Features", seq_len(nrow(tcga_dense_se)))

discov_tcga_dense <- tcga_dense_se[, ! tcga_dense_se$`sample type:ch1`  %in% c("Control for validation cohort",  "Validation cohort") ]
valid_tcga_dense <- tcga_dense_se[, tcga_dense_se$`sample type:ch1`  %in% c("Control for validation cohort",  "Validation cohort") ]
```

We obtained `r nrow(tcga_dense_se)` features from the dense layer. Of those, `r sum(!apply(tcga_dense, 2, function(x) all(x == 0)))` had values different than 0 in at least a sample.

```{r}
pc_tcga_dense <- prcomp(tcga_dense)$x %>%
  data.frame()
rownames(pc_tcga_dense) <- colnames(tcga_dense_se)
pc_tcga_dense$disease <- colData(se)[rownames(pc_tcga_dense), "disease"]
pc_tcga_dense$sex <- colData(se)[rownames(pc_tcga_dense), "sex"]
```

```{r}
pc_tcga_dense %>% 
  ggplot(aes(x = PC1, y = PC2, color = disease)) +
  geom_point() + 
  theme_bw() +
  ggtitle("TCGA dense features - Disease")
```

The top 2 PCs of dense features from TCGA model does not allow differentiating the cases from the the control individuals.

```{r}
pc_tcga_dense %>% 
  ggplot(aes(x = PC2, y = PC4, color = disease)) +
  geom_point() + 
  theme_bw() +
  ggtitle("TCGA dense features - Disease")
```

Components PC2 and PC4 of features from TCGA dense cluster samples by disease type. Nonetheless, the clustering was better when using the all the CpGs or the CNN features.

```{r}
pc_tcga_dense %>% 
  ggplot(aes(x = PC1, y = PC2, color = sex)) +
  geom_point() + 
  theme_bw() +
  ggtitle("TCGA dense features - Sex")
```

Again, the first component clearly cluster samples by sex.

Summary: the features computed by the TCGA dense model are capturing the difference in methylation due to sex, while the differences due to the disease are not well captured.

### Features selection

Due to the high number of features without significant values, we remove them before selecting the features.

```{r}
sel_tcga_dense <- lapply(diseases, getFeatures, set = discov_tcga_dense[!apply(tcga_dense, 2, function(x) all(x == 0)), ], minFC = 0)
sel_tcga_dense_vec <- unique(unlist(sel_tcga_dense))
```

A total of `r length(sel_tcga_dense$CHARGE)` and `r length(sel_tcga_dense$Kabuki)` features had different methylation values in controls than in CHARGE or Kabuki, respectively.

```{r}
pheatmap(assay(discov_tcga_dense)[sel_tcga_dense_vec, ], scale = "none", 
         annotation_col  = data.frame(colData(discov_tcga_dense)[, c("disease", "sex"), drop = FALSE]),
         annotation_colors =  col_colors, 
         show_rownames = FALSE)

```

Selected features are not enough to differentiate cases from controls. Nonetheless, samples are separated by sex.

```{r}
pheatmap(assay(valid_tcga_dense)[sel_tcga_dense_vec, ], scale = "none", 
         annotation_col  = data.frame(colData(valid_tcga_dense)[, c("disease", "sex"), drop = FALSE]),
         annotation_colors =  col_colors, 
         show_rownames = FALSE)

```

These features do not work better in the samples with variants.

### SVM model

Due to the low number of features selected, we included all features different than 0 from the dense layer.

```{r}
svm_tcga_dense <- trainSVM(set = discov_tcga_dense, feats = rownames(discov_tcga_dense)[!apply(tcga_dense, 2, function(x) all(x == 0))])

pred_tcga_dense <- predict(svm_tcga_dense, t(assay(tcga_dense_se)))
table(pred_tcga_dense, se$disease)

```

The SVM model is unable to differentiate the cases from controls with the features with relevant values of the dense network. No samples are identified as Kabuki, suggesting that signal of Kabuki samples has been lost. Although some samples are identified as CHARGE, there is a great confussion between CHARGE and controls. Even, some Kabuki samples are identified as CHARGE.

Summary: The dense layer does not contain enough information to differentiate cases and controls.

# Blood model

## Description

We trained a CNN model in a blood reference dataset whose goal was to classifiy samples into their sex. The input contained the 3528 samples (80% training/20% test) 470870 CpGs present in the original dataset. Then, the model had the following layers:

| Layer (type)                  | Output Shape      | Param \#  |
|-------------------------------|-------------------|-----------|
| conv1d_1 (Conv1D)             | (None, 117715, 2) | 30        |
| activation_1 (Activation)     | (None, 117715, 2) | 0         |
| max_pooling1d_1 (MaxPooling1) | (None, 58857, 2)  | 0         |
| flatten_1 (Flatten)           | (None, 117714)    | 0         |
| dense_1 (Dense)               | (None, 1024)      | 120540160 |
| dense_2 (Dense)               | (None, 2)         | 2050      |

Hyperparameters (from random search):

-   CNN kernel size: 13
-   CNN stride: 4
-   Max pool size: 2
-   Activation: relu

## CNN output

### General pattern

We first evaluated whether the output of the CNN layers still contained signal to differentiate the individuals by disease.

```{r}
blood_cnn <- read_delim("../results/gse97362_Blood/2021-09-28/model_features/flatten_1.tsv", delim = "\t")
blood_cnn <- data.matrix(blood_cnn)

blood_cnn_se <- SummarizedExperiment(t(blood_cnn), colData = colData(se))
rownames(blood_cnn_se) <- paste0("Features", seq_len(nrow(blood_cnn_se)))

discov_blood_cnn <- blood_cnn_se[, ! blood_cnn_se$`sample type:ch1`  %in% c("Control for validation cohort",  "Validation cohort") ]
valid_blood_cnn <- blood_cnn_se[, blood_cnn_se$`sample type:ch1`  %in% c("Control for validation cohort",  "Validation cohort") ]
```

We obtained `r nrow(blood_cnn_se)` features from the CNN layer. Of those, `r sum(!apply(blood_cnn, 2, function(x) all(x == 0)))` had values different than 0 in at least a sample.

```{r}
pc_blood_cnn <- prcomp(blood_cnn)$x %>%
  data.frame()
rownames(pc_blood_cnn) <- colnames(blood_cnn_se)
pc_blood_cnn$disease <- colData(se)[rownames(pc_blood_cnn), "disease"]
pc_blood_cnn$sex <- colData(se)[rownames(pc_blood_cnn), "sex"]
```

```{r}
pc_blood_cnn %>% 
  ggplot(aes(x = PC1, y = PC2, color = disease)) +
  geom_point() + 
  theme_bw() +
  ggtitle("blood CNN features - Disease")
```

The top 2 PCs of CNN features from TCGA model does not allow differentiating the cases from the the control individuals.

```{r}
pc_blood_cnn %>% 
  ggplot(aes(x = PC3, y = PC9, color = disease)) +
  geom_point() + 
  theme_bw() +
  ggtitle("blood CNN features - Disease")
```

Components PC3 and PC9 of features from TCGA CNN cluster samples by disease type. Nonetheless, the clustering was better when using the full dataset.

```{r}
pc_blood_cnn %>% 
  ggplot(aes(x = PC1, y = PC2, color = sex)) +
  geom_point() + 
  theme_bw() +
  ggtitle("blood CNN features - Sex")
```

The first components are not able to differentiate samples by sex.

Summary: the features computed by the blood model are not able to recapitulate well disease nor sex.

### Features selection

```{r}
sel_blood_cnn <- lapply(diseases, getFeatures, set = discov_blood_cnn, minFC = 0.05)
sel_blood_cnn_vec <- unique(unlist(sel_blood_cnn))
```

A total of `r length(sel_tcga_cnn$CHARGE)` and `r length(sel_tcga_cnn$Kabuki)` features had different methylation values in controls than in CHARGE or Kabuki, respectively.

```{r}
pheatmap(assay(discov_blood_cnn)[sel_blood_cnn_vec, ], scale = "none", 
         annotation_col  = data.frame(colData(discov_blood_cnn)[, c("disease", "sex"), drop = FALSE]),
         annotation_colors =  col_colors, 
         show_rownames = FALSE)

```

Using the top selected features, we are able to clearly differentiate controls from the disease samples.

```{r}
pheatmap(assay(valid_blood_cnn)[sel_blood_cnn_vec, ], scale = "none", 
         annotation_col  = data.frame(colData(valid_blood_cnn)[, c("disease", "sex"), drop = FALSE]),
         annotation_colors =  col_colors, 
         show_rownames = FALSE)
```

We observed clusters of individuals with suspicious variants separated from controls.

### SVM training

```{r}
svm_blood_cnn <- trainSVM(set = discov_blood_cnn, feats = sel_blood_cnn_vec)

pred_blood_cnn <- predict(svm_blood_cnn, t(assay(blood_cnn_se)))
table(pred_blood_cnn, se$disease)

```

With this data, the SVM model presented a lower accuracy. Now, it missclassified 11 control individuals identified as cases. The classification of samples with suspicious variants was not good either, with some samples with suspicious variants classified in a different disease type.

Summary: The CNN network have reduced the differences between the different disease group, and some importante mistakes are done.

## Dense network output

### General pattern

We first evaluated whether the output of the dense layer still contained signal to differentiate the individuals by disease.

```{r}
blood_dense <- read_delim("../results/gse97362_Blood/2021-09-28/model_features/dense_1.tsv", delim = "\t")
blood_dense <- data.matrix(blood_dense)

blood_dense_se <- SummarizedExperiment(t(blood_dense), colData = colData(se))
rownames(blood_dense_se) <- paste0("Features", seq_len(nrow(blood_dense_se)))

discov_blood_dense <- blood_dense_se[, ! blood_dense_se$`sample type:ch1`  %in% c("Control for validation cohort",  "Validation cohort") ]
valid_blood_dense <- blood_dense_se[, blood_dense_se$`sample type:ch1`  %in% c("Control for validation cohort",  "Validation cohort") ]
```

We obtained `r nrow(blood_dense_se)` features from the dense layer. Of those, `r sum(!apply(blood_dense, 2, function(x) all(x == 0)))` had values different than 0 in at least a sample.

```{r}
pc_blood_dense <- prcomp(blood_dense)$x %>%
  data.frame()
rownames(pc_blood_dense) <- colnames(blood_dense_se)
pc_blood_dense$disease <- colData(se)[rownames(pc_blood_dense), "disease"]
pc_blood_dense$sex <- colData(se)[rownames(pc_blood_dense), "sex"]
```

```{r}
pc_blood_dense %>% 
  ggplot(aes(x = PC1, y = PC2, color = disease)) +
  geom_point() + 
  theme_bw() +
  ggtitle("blood dense features - Disease")
```

The top 2 PCs of dense features from blood model does not allow differentiating the cases from the the control individuals. We could not find a good clustering in any PC.

```{r}
pc_blood_dense %>% 
  ggplot(aes(x = PC1, y = PC2, color = sex)) +
  geom_point() + 
  theme_bw() +
  ggtitle("blood dense features - Sex")
```

The second PC separates samples by sex but the separation was better for TCGA.

Summary: the features computed by the blood dense model are capturing the difference in methylation due to sex, while the differences due to the disease are not well captured.

### Features selection

Due to the high number of features without significant values, we remove them before selecting the features.

```{r}
sel_blood_dense <- lapply(diseases, getFeatures, set = discov_blood_dense[!apply(blood_dense, 2, function(x) all(x == 0)), ], minFC = 0)
sel_blood_dense_vec <- unique(unlist(sel_blood_dense))
```

A total of `r length(sel_blood_dense$CHARGE)` and `r length(sel_blood_dense$Kabuki)` features had different methylation values in controls than in CHARGE or Kabuki, respectively.

```{r}
pheatmap(assay(discov_blood_dense)[sel_blood_dense_vec, ], scale = "none", 
         annotation_col  = data.frame(colData(discov_blood_dense)[, c("disease", "sex"), drop = FALSE]),
         annotation_colors =  col_colors, 
         show_rownames = FALSE)

```

Only a subgroup of Kabuki samples are separated from controls. CHARGE samples are clustered with the controls.

```{r}
pheatmap(assay(valid_blood_dense)[sel_blood_dense_vec, ], scale = "none", 
         annotation_col  = data.frame(colData(valid_blood_dense)[, c("disease", "sex"), drop = FALSE]),
         annotation_colors =  col_colors, 
         show_rownames = FALSE)

```

These features do not differentiate the samples with variants from controls.

### SVM model

Due to the low number of features selected, we included all features different than 0 from the dense layer.

```{r}
svm_blood_dense <- trainSVM(set = discov_blood_dense, feats = sel_blood_dense_vec)

pred_blood_dense <- predict(svm_blood_dense, t(assay(blood_dense_se)))
table(pred_blood_dense, se$disease)

```

The SVM model only classifies few Kabuki samples as Kabuki. Nonetheless, other CHARGE samples are classified as Kabuki instead than as CHARGE. Most of the reamining samples are classified as control.

Summary: The dense layer does not contain enough information to differentiate cases and controls.

# Summary

The CNN network from the TCGA seems to recapitulate better the general methylation patterns in the samples, even if the input samples were very different. Surprisingly, the features from TCGA were better than the features from the blood model to get the samples' sex, although the blood model was trained to determine sex.
